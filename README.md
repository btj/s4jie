# sfjie
Specs (= method pre- and postconditions) for Java in Eclipse

The goal of this project is to hack Eclipse's Java development tooling so that it supports editing and building programs that specify preconditions and postconditions for methods as boolean Java expressions inside comments, like so:
```java
class Account {

    private int balance;
    
    public int getBalance() { return balance; }
    
    public Account()
        //@ post getBalance() == 0;
    {}
    
    public void deposit(int amount)
        //@ pre 0 <= amount;
        //@ post getBalance() == old(getBalance()) + amount;
    {
        balance += amount;
    }
    
    public void withdraw(int amount)
        //@ pre 0 <= amount && amount <= getBalance();
        //@ post getBalance() == old(getBalance()) - amount;
    {
        balance -= amount;
    }

}
```
Edit-time support should include syntax highlighting, squigglies indicating malformed or ill-typed fragments, code completion, and refactoring. Build-time support should include optionally generating run-time checks. The hacked Eclipse should be suitable for use by students as part of their Java programming course.

It should be as easy as possible to keep the hacked Eclipse up-to-date with the upstream Eclipse, so as to incorporate work done upstream to support new Java language features, add new editor features, fix bugs, etc.

Resources
=========

- [JDT Core Development Resources](http://www.eclipse.org/jdt/core/dev.php)
- [JDT Core Committer FAQ](http://wiki.eclipse.org/JDT_Core_Committer_FAQ)
- [Where is the JDT/Core Code?](http://wiki.eclipse.org/JDT_Core_Committer_FAQ#Where_is_the_JDT.2FCore_code.3F)
- [GitHub mirror of the JDT/Core Git repository](https://github.com/eclipse/eclipse.jdt.core)
- [Eclipse Bugzilla](https://bugs.eclipse.org/bugs/buglist.cgi?component=Core&product=JDT&resolution=---)
- [JDT Project](https://projects.eclipse.org/projects/eclipse.jdt)
- [org.eclipse.jdt.core Plugin Sources](https://github.com/eclipse/eclipse.jdt.core/tree/master/org.eclipse.jdt.core)

The Parser
==========

The JDT Java parser is in class [`org.eclipse.jdt.internal.compiler.parser.Parser`](https://github.com/eclipse/eclipse.jdt.core/blob/master/org.eclipse.jdt.core/compiler/org/eclipse/jdt/internal/compiler/parser/Parser.java). It is an LR parser; the LR tables are generated from the grammar file [`java.g`](https://github.com/eclipse/eclipse.jdt.core/blob/master/org.eclipse.jdt.core/grammar/java.g) using the JikesPG parser generator. The process is described in document [How to: Generate the Parser](http://www.eclipse.org/jdt/core/howto/generate%20parser/generateParser.html). A number of manual steps are required to transform the files generated by JikesPG.

JikesPG was originally developed as the parser generator for the IBM Jikes Java compiler. It was eventually released on [SourceForge](https://sourceforge.net/projects/jikes/files/Jikes%20Parser%20Generator/) by Chris Abbey and Dave Shields. This is where the "How to" document points. However, recently Dave Shields created a [GitHub repo](https://github.com/daveshields/jikespg) for JikesPG. I [forked](https://github.com/btj/jikespg) it.

Simplifying the Parser Generation Process
=========================================

TokenName$eof and TokenName$error
---------------------------------

The current grammar causes JikesPG to emit constants named `TokenName$eof` and `TokenName$error` to `javasym.java`. These currently need to be renamed manually to `TokenNameEOF` and `TokenNameERROR` when copying `javasym.java` to `TerminalTokens.java`.

It turns out that simply adding
```
$Terminals

    [...]
    EOF
    ERROR

$Alias

    [...]
    $EOF ::= EOF
    $ERROR ::= ERROR
```
to `java.g` (exactly like what both example grammars that ship with JikesPG do) causes JikesPG to emit the correct names into `javasym.java`. I tested it on Ubuntu; there it works correctly. On Cygwin, however, this input causes JikesPG to crash. I have so far been unable to determine the precise cause of the crash; running in `gdb` after compiling with `-g` does not help.

To find bugs in JikesPG, on Ubuntu it is useful to compile with `-fsanitize=address`. Running this build on `java.g` stops after detecting that in `lpgparse.c:678`, a `memcmp` call is performed with a length that is greater than one of the input buffers. This is a potential buffer overread but cannot be the cause of the Cygwin crash. To stop AddressSanitizer from detecting these, run JikesPG with `ASAN_OPTIONS=strict_memcmp=false`. When doing so, the next error detected is a stack buffer overflow at `mkfirst.c:1613`. This bug, and another one, are fixed by https://github.com/btj/jikespg/commit/81183981d4d5ac1aac3fa4b5e5d14c39e017043c . After that, if detecting leaks is disabled using `ASAN_OPTIONS=strict_memcmp=false:detect_leaks=false`, running JikesPG on `java.g` succeeds. Running the fixed version on Cygwin now succeeds as well.
